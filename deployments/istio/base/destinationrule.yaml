apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: api-destinationrule
  namespace: my-api
  labels:
    app.kubernetes.io/name: api-destinationrule
    app.kubernetes.io/part-of: python-api-base
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  host: my-api
  trafficPolicy:
    # Connection pool settings
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
    
    # Circuit breaker (outlier detection)
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30
      splitExternalLocalOriginErrors: true
      consecutiveLocalOriginFailures: 5
      consecutiveGatewayErrors: 5
    
    # Load balancing
    loadBalancer:
      simple: LEAST_REQUEST
      localityLbSetting:
        enabled: true
        failover:
          - from: us-east-1
            to: us-west-2
    
    # mTLS configuration
    tls:
      mode: ISTIO_MUTUAL
  
  # Subsets for canary deployments
  subsets:
    - name: stable
      labels:
        version: stable
      trafficPolicy:
        connectionPool:
          http:
            http2MaxRequests: 1000
    - name: canary
      labels:
        version: canary
      trafficPolicy:
        connectionPool:
          http:
            http2MaxRequests: 100
